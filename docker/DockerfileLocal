ARG DOCKER_REGISTRY=registry.red-soft.ru
ARG NPM_IMAGE=$DOCKER_REGISTRY/ubi8/nodejs-20:latest
ARG NGINX_IMAGE=$DOCKER_REGISTRY/ubi8/nginx:latest


FROM $NPM_IMAGE AS node

USER 0

COPY --chown=1001 package*.json vite.config.ts index.html tsconfig.json global.d.ts ./

ARG NPM_REGISTRY=https://registry.npmjs.org/
RUN npm update -g npm --registry=${NPM_REGISTRY} && npm install --registry=${NPM_REGISTRY}

COPY --chown=1001 src ./src
COPY --chown=1001 public ./public

RUN npm run build

USER 1001

FROM $NGINX_IMAGE

# root
USER 0

# Копирует бандл из промежуточного лейера
COPY --chown=1001:0 --from=node /opt/app-root/src/build/ /opt/app-root/src/

# Удаляем лишних пользователей
RUN userdel -f nginx && userdel -f mail && userdel -f sync && userdel -f games && userdel -f ftp
# Удаляем все что предоставляется из коробки
RUN rm -rf /etc/nginx/ && rm -rf /usr/lib64/nginx/ && rm -rf /usr/share/nginx/ && rm -rf /var/www/html/nginx/

# Зарезаем права директории nginx до минимальных. Чтение и запись доступны только воадельцу.
RUN mkdir /etc/nginx/ && chown -R 1001:0 /etc/nginx/ 

# Создаем pid и даем минимальные полномочия
RUN mkdir -p /var/run/nginx/ && touch /var/run/nginx/nginx.pid && chown 1001:0 /var/run/nginx/nginx.pid && chmod 644 /var/run/nginx/nginx.pid

# Копируем локальный nginx.conf. В КСПД монтируется ерез конфигмапу
COPY --chown=1001:0 ./docker/nginx/nginx.conf.local /etc/nginx/nginx.conf

# non root
USER 1001

EXPOSE 8080

CMD exec nginx -g 'daemon off;'
